USE [FAHESVIS]
GO
/****** Object:  StoredProcedure [dbo].[SP_SysAdmin_GetFahesLogs]    Script Date: 6/2/2024 12:14:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Thaer ALkilani>
-- Create date: <30/05/2024> 
-- Description:	get APP Logs
-- =============================================
	ALTER PROCEDURE [dbo].[SP_SysAdmin_GetFahesLogs]
    @Log_Id INT = NULL,
    @Log_Type INT = NULL,
    @User_Id INT = NULL,
    @Source INT = NULL,
	@username NVARCHAR(45) = NULL,
	@userFullName NVARCHAR(45) = NULL,
    @IPAddress NVARCHAR(45) = NULL,
    @From_Date DATETIME = NULL,
    @To_Date DATETIME = NULL,
    @Result INT OUTPUT,
    @Error_Message NVARCHAR(MAX) OUTPUT,
    @DB_Error_Message NVARCHAR(MAX) OUTPUT
AS
BEGIN
    BEGIN TRY
        SELECT
            fl.Log_Id AS LogId,
            fl.Log_Type AS LogType,
            LookupLogType.LookUpValueEn AS LogTypeDescription, 
            fl.User_Id AS UserId,
			u.username,
			u.User_Full_Name userFullName,
            fl.Message,
            fl.Created_Date AS CreatedDate,
            fl.Source,
			LookupSource.LookUpValueEn as SourceDescription,
            fl.IPAddress
        FROM
             [dbo].[FAHES_Logs] fl
          CROSS APPLY 
				dbo.Fn_Core_Get_LookUp_TBL(82, fl.Log_Type ) AS LookupLogType
		    CROSS APPLY 
				dbo.Fn_Core_Get_LookUp_TBL(70, fl.Source ) AS LookupSource
		  inner join users u on u.user_id =  fl.user_id
        WHERE
            (@Log_Id IS NULL OR fl.Log_Id = @Log_Id)
            AND (@Log_Type IS NULL OR fl.Log_Type = @Log_Type)
            AND (@User_Id IS NULL OR fl.User_Id = @User_Id)
            AND (@Source IS NULL OR fl.Source = @Source)
            AND (@IPAddress IS NULL OR fl.IPAddress LIKE '%' + @IPAddress + '%')
			AND (@username IS NULL OR u.Username LIKE '%' + @username + '%')
			AND (@userFullName IS NULL OR u.User_Full_Name LIKE '%' + @userFullName + '%')
            AND (@From_Date IS NULL OR fl.Created_Date >= @From_Date)
            AND (@To_Date IS NULL OR fl.Created_Date <= @To_Date)

        SET @Result = 1;  -- Indicate success
    END TRY
    BEGIN CATCH
        SET @DB_Error_Message = ERROR_MESSAGE();
        SET @Result = -1;  -- Indicate failure
        RETURN;
    END CATCH;
END;
